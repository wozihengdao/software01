<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/axios-0.18.0.js"></script>
    <script src="js/vue.js"></script>
    <script src="element-ui/lib/index.js"></script>
    <link rel="stylesheet" href="element-ui/lib/theme-chalk/index.css">
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="js/storage.js"></script>
      <script src="js/kimiAPI.js"></script>
    <script src="js/onload.js"></script>



    <style>
        #chat-container {
            margin: 0px 50px;
            height: 690px;
            width: 600px;
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
        }
        .user-message, .bot-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .user-message {
            background-color: #e3f2fd;
            margin-left: 20%;
        }
        .bot-message {
            background-color: #f5f5f5;
            margin-right: 20%;
        }
        #input-container {
            display: flex;
            padding: 0px 50px;
            width: 720px;
            gap: 10px;
        }
        #user-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #send-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }



        /*-----------------------------------------------------------------------------------------------------------*/


        .message-drawer {
            height: 100%;
        }

        /* 滚动容器 */
        .scroll-container {
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: 20px;
        }

        .order-col {
            margin-bottom: 16px;
        }

        .order-card {
            border-radius: 8px;
            transition: all 0.3s;
        }

        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 卡片头部 */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .order-type {
            font-size: 14px;
            padding: 6px 12px;
        }

        .order-info {
            text-align: right;
        }

        .order-id {
            color: #606266;
            font-size: 14px;
        }

        /* 超时提示 */
        .overdue-alert {
            color: #f56c6c;
            font-size: 12px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* 日期信息 */
        .date-info {
            display: flex;
            align-items: center;
            color: #909399;
            font-size: 13px;
        }

        .date-icon {
            margin-right: 6px;
            font-size: 16px;
        }

        /* 响应式适配 */
        @media (max-width: 768px) {
            .scroll-container {
                padding: 10px;
            }

            .order-card {
                margin-bottom: 12px;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .order-info {
                width: 100%;
                text-align: left;
            }
        }
    </style>


</head>
<body>

<style scoped>
    .info-item {
        margin: 8px 28px;
        line-height: 15px;
    }

    .info-label {
        color: #909399;
        margin-right: 10px;
    }

    .info-content {
        color: #606266;
    }

    .image {
        width: 100%;
        height: 270px;
        object-fit: cover;
        display: block;
    }

    .button {
        width: 100%;
        margin-top: 5px;
    }
     .dashboard-container {
         /*background-color: rgba(0,0,0,0.1);*/
         padding: 20px;
         display: flex;
         gap: 20px;
     }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        flex: 1;
        box-shadow: 0 2px 12px 0 rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
    }

    .color-block {
        width: 70px;
        height: 70px;

        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
    }

    .stat-content {
        flex: 1;
    }

    .stat-number {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-title {
        font-size: 14px;
        color: #666;
    }

    /* 颜色定义 */
    .blue { background-color: #409EFF; }
    .green { background-color: #67C23A; }
    .orange { background-color: #E6A23C; }
    .yellow { background-color: #E6C23C; }

    /* 图标颜色 */
    .color-block i {
        color: white;
        font-size: 24px;
    }

</style>


<div id="app">

    <el-container>
        <el-aside width="200px" style="background-color: #545c64; height: 100vh">
            <el-menu
                    :default-active="activeIndex1"
                    @select="handleMenuItemClick"
                    background-color="#545c64"
                    text-color="#fff"
                    active-text-color="#ffd04b">
                <el-menu-item-group title="主菜单">
                    <el-menu-item index="1">
                        <i class="el-icon-user"></i>
                        <span>个人信息</span>
                    </el-menu-item>
                    <el-menu-item index="2">
                        <i class="el-icon-menu"></i>
                        <span>功能面板</span>
                    </el-menu-item>
                    <el-menu-item index="3">
                        <i class="el-icon-phone"></i>
                        <span>联系我们</span>
                    </el-menu-item>
                    <el-menu-item index="4">
                        <i class="el-icon-switch-button"></i>
                        <span>退出登录</span>
                    </el-menu-item>

                </el-menu-item-group>
            </el-menu>
        </el-aside>


        <el-container>

<!--            侧栏-->
            <div v-if="activeIndex1==2" style="width:1500px">
                <el-header>

                    <el-menu
                            :default-active="activeIndex2"
                            class="el-menu-demo"
                            mode="horizontal"
                            @select="handleSelect"
                            background-color="#545c64"
                            text-color="#fff"
                            active-text-color="#ffd04b"

                    >

                        <el-menu-item index="1">首页</el-menu-item>
                        <el-menu-item index="2">报修</el-menu-item>
                        <el-menu-item index="3">维修</el-menu-item>
                        <el-menu-item index="4">保养</el-menu-item>
                        <el-menu-item index="5">巡检</el-menu-item>
                        <el-menu-item index="6">检测</el-menu-item>
                        <el-menu-item index="7">备件</el-menu-item>

<!--                        抽屉-->
<!--                      消息  -->
                        <el-menu-item index="8" style="position: relative; left: 700px"><i class="el-icon-message"></i></el-menu-item>
<!--                        AI-->
                        <el-menu-item index="9" style="position: relative; left: 700px"><i class="el-icon-orange"> </i></el-menu-item>
                    </el-menu>

                </el-header>
                <el-main>


                    </el-button>

                    <el-drawer
                            title="消息"
                            :visible.sync="drawer"
                            direction="rtl"
                            size="30%"
                            :wrapper-closable="false"
                            :before-close="handleClose"
                    >
                        <div class="message-drawer">
                            <!-- 滚动容器 -->
                            <div class="scroll-container">
                                <el-row :gutter="20">
                                    <!-- 工单列表 -->
                                    <el-col
                                            v-for="(item, index) in List"
                                            :key="item.id"
                                            :span="24"
                                            class="order-col"
                                    >
                                        <el-card class="order-card">
                                            <!-- 卡片头部 -->
                                            <div class="card-header">
                                                <el-tag
                                                        effect="dark"
                                                        type="primary"
                                                        class="order-type"
                                                        style="display: inline-flex; align-items: center; justify-content: center; padding: 0 12px;"
                                                >{{ item.kind }}</el-tag>

                                                <div class="order-info">
                                                    <div class="order-id">工单号：{{ (item.id) }}</div>
                                                    <div

                                                            class="overdue-alert"
                                                    >
                                                        <el-icon><i class="el-icon-warning"></i></el-icon>
                                                        已超时，请尽快处理！
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 卡片内容 -->
                                            <div class="card-content">
                                                <div class="date-info">
                                                    <el-icon class="date-icon"><i class="el-icon-date"></i></el-icon>
                                                    <span>接收日期：{{item.data}}</span>
                                                </div>
                                            </div>
                                        </el-card>
                                    </el-col>
                                </el-row>
                            </div>
                        </div>
                    </el-drawer>

                    <el-drawer
                            title="智慧巡检助手"
                            :visible.sync="drawer01"
                            direction="rtl"
                            size="40%"
                            :before-close="handleClose"
                            :wrapper-closable="false"
                            :before-close="handleClose"
                            @opened="initChat"

                    >

                        <div id="chat-container" ></div>
                        <div id="input-container">
                            <input type="text" id="user-input" placeholder="请输入您的问题...">
                            <button id="send-button">发送</button>
                        </div>

                    </el-drawer>


<!--          卡片-->
                    <div class="dashboard-container">
                        <!-- 用户访问量 -->
                        <div class="stat-card">
                            <div class="color-block blue">
                                <i class="el-icon-user"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">12</div>
                                <div class="stat-title">用户访问量</div>
                            </div>
                        </div>

                        <!-- 系统消息 -->
                        <div class="stat-card">
                            <div class="color-block green">
                                <i class="el-icon-message"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">18</div>
                                <div class="stat-title">系统消息</div>
                            </div>
                        </div>

                        <!-- 商品数量 -->
                        <div class="stat-card">
                            <div class="color-block orange">
                                <i class="el-icon-document"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">153</div>
                                <div class="stat-title">工单数量</div>
                            </div>
                        </div>

                        <!-- 今日订单 -->
                        <div class="stat-card">
                            <div class="color-block yellow">
                                <i class="el-icon-monitor"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-number">23</div>
                                <div class="stat-title">运行设备数量</div>
                            </div>
                        </div>
                    </div>
<!--          图表-->

                    <div class="stat-card" style="width: 1000px;position:relative;top:20px;left:15px">
                <div id="container01" style="height: 500px;width:1000px"></div>
                    </div>
                     <br>
                    <br>
                    <div class="stat-card" style="width: 290px;position:relative;top:-565.5px;left:1080px">
                        <div id="container02" style="height: 500px;width:1000px"></div>
                    </div>

                </el-main>


            </div>
        </el-container>
    </el-container>

</div>
</body>

<script type="module">
    import storage from "./storage.js";
    new Vue({
            el:"#app",
            data() {
                return {
                    List:[],
                    drawer: false,
                    direction: 'rtl',
                    drawer01: false,
                    direction01: 'rtl',
                    repairOrderList:[],
                    activeIndex1: '2',
                    activeIndex2: '1',
                    dialogVisible:false,
                    repairOrder:{},
                    dialogImageUrl: '',
                    stationList:[],
                    disabled: false,
                    tableData:[],
                    ans:''
                };
            },
            mounted() {

                axios.post("http://localhost:7469/MaintenanceManage/repairOrder/allOrderToAI",storage.get('user').username).then((res)=>{

                    this.ans=res.data;
                })

                axios.post("http://localhost:7469/MaintenanceManage/repairOrder/allOrder",storage.get('user').username).then((res)=>{
                    console.log(res.data);
                    this.List=res.data;



                })


                    const echarts = window.echarts;
                    const dom = document.getElementById('container01');
                    if (!dom) return;

                    const myChart = echarts.init(dom, null, {
                        renderer: 'canvas',
                        useDirtyRect: false
                    });

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'cross',
                                label: {
                                    backgroundColor: '#6a7985'
                                }
                            }
                        },
                        title: { text: '工单统计' },

                        legend: { data: [ '保养单', '备件单','巡检单', '检测单','维修单' ] },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: { type: 'category', data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'] ,boundaryGap: false},
                        yAxis: { type: 'value' },
                        series: [     {
                            name: '维修单',
                            type: 'line',
                            stack: 'Total',

                         //   smooth: true,
                            areaStyle: {},
                            emphasis: {
                                focus: 'series'
                            },
                            label: {
                                show: true,
                                position: 'top'
                            },
                            data: [10, 14, 12, 10, 7, 12, 13]
                        },
                            {
                          //      smooth: true,
                                name: '保养单',
                                type: 'line',
                                stack: 'Total',
                                areaStyle: {},
                                emphasis: {
                                    focus: 'series'
                                },
                                label: {
                                    show: true,
                                    position: 'top'
                                },
                                data: [9, 12, 14, 16, 16, 14, 12]

                            },
                            {
                          //      smooth: true,
                                name: '备件单',
                                type: 'line',
                                stack: 'Total',
                                areaStyle: {},
                                label: {
                                    show: true,
                                    position: 'top'
                                },
                                emphasis: {
                                    focus: 'series'
                                },
                                data: [12, 12, 13, 14, 18, 12, 9],

                            },
                            {
                            //    smooth: true,
                                name: '巡检单',
                                type: 'line',
                                stack: 'Total',
                                areaStyle: {},
                                emphasis: {
                                    focus: 'series'
                                },
                                label: {
                                    show: true,
                                    position: 'top'
                                },
                                data: [12, 17, 11, 13, 17, 13, 12]
                            },
                            {
                            //    smooth: true,
                                name: '检测单',
                                type: 'line',
                                stack: 'Total',
                                areaStyle: {},
                                emphasis: {
                                    focus: 'series'
                                },
                                label: {
                                    show: true,
                                    position: 'top'
                                },
                                data: [12, 12,17, 14, 18, 20, 16]
                            }
                        ]
                    };


                    myChart.setOption(option);
                    window.addEventListener('resize', myChart.resize);

                const dom02 = document.getElementById('container02');
                if (!dom02) return;

                const myChart02 = echarts.init(dom02, null, {
                    renderer: 'canvas',
                    useDirtyRect: false
                });

                const option02 = {
                    title: {
                        text: '占比分析',
                        subtext: '',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item'
                    },
                    legend: {
                        top: '80%',
                        left: 'center'
                    },
                    series: [
                        {center: ['50%', '45%'],
                            name: '详细信息',
                            type: 'pie',
                            radius: ['40%', '70%'],
                            avoidLabelOverlap: false,
                            padAngle: 5,
                            itemStyle: {
                                borderRadius: 10
                            },
                            label: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                label: {
                                    show: true,
                                    fontSize: 40,
                                    fontWeight: 'bold'
                                }
                            },
                            labelLine: {
                                show: false
                            },
                            data: [
                                { value: 30, name: '超时完成' },
                                { value: 120, name: '按时完成' },
                                { value: 50, name: '待完成' },
                                { value: 30, name: '超时未完成' },

                            ]
                        }
                    ]
                };

                if (option02 && typeof option02 === 'object') {
                    myChart02.setOption(option02);
                }

                window.addEventListener('resize', myChart.resize);

                axios.post("http://localhost:7469/MaintenanceManage/stop/selectAll",).then((res) => {

                    this.stationList = res.data;

                })

                axios.post("http://localhost:7469/MaintenanceManage/repairOrder/selectAll",).then((res) => {

                    this.tableData= res.data;

                })
            }
            ,
            methods: {
                initChat() {
                    this.$nextTick(() => {
                        this.setupChat();
                        this.listVoices();
                    });
                },
                listVoices() {
                    window.speechSynthesis.getVoices().forEach((voice, i) => console.log(i + ': ' + voice.name + ' (' + voice.lang + ')'));
                },
                setupChat() {
                    const container = document.getElementById('chat-container');
                    container.innerHTML = '';
                    // 欢迎打字机
                    const botDiv = document.createElement('div');
                    botDiv.classList.add('bot-message');
                    botDiv.innerHTML = `
        <div class="avatar-container">
          <img src="./02.png" alt="Kimi Avatar" width="50px"/>
          <span class="username">智慧巡检助手</span>
        </div>
        <div class="message-content" id="welcome-message"></div>
      `;
                    container.appendChild(botDiv);
                    const text = '我是智慧巡检助手，很高兴为您服务:';
                    let idx = 0;
                    const welcomeEl = botDiv.querySelector('#welcome-message');
                    const timer = setInterval(() => {
                        if (idx < text.length) {
                            welcomeEl.textContent += text[idx++];
                            container.scrollTop = container.scrollHeight;
                        } else {
                            clearInterval(timer);
                        }
                    }, 50);
                    // 绑定发送按钮
                    const btn = document.getElementById('send-button');
                    if (btn) btn.onclick = () => {
                        const msg = document.getElementById('user-input').value.trim();
                        if (msg) { this.sendMessage(msg); document.getElementById('user-input').value = ''; }
                    };
                },
                sendMessage(message) {
                    const container = document.getElementById('chat-container');
                    // 用户消息
                    const userDiv = document.createElement('div');
                    userDiv.classList.add('user-message');
                    userDiv.innerHTML = `<div class="message-content">${message}</div>`;
                    container.appendChild(userDiv);
                    container.scrollTop = container.scrollHeight;
                    // 机器人思考
                    const botDiv = document.createElement('div');
                    botDiv.classList.add('bot-message');
                    container.appendChild(botDiv);
                    let dots = '', dotI = setInterval(() => {
                        dots = dots.length < 6 ? dots + '.' : '.';
                        botDiv.innerHTML = `
          <div class="avatar-container">
            <img src="./02.png" alt="Kimi Avatar" width="50px"/>
            <span class="username">智慧巡检助手</span>
          </div>
          <div class="message-content" id="bot-mes">正在思考中${dots}</div>
        `;
                        container.scrollTop = container.scrollHeight;
                    }, 500);
                    // 调用后端 API
                    const apiUrl = 'https://api.moonshot.cn/v1/chat/completions';
                    const payload = {
                        model: 'moonshot-v1-8k',
                        messages: [
                            { role: 'system', content: `
            你是DeepSeek与巡洋检修系统结合的大模型，你的名字是智慧巡检助手，你是用户的小助手为他解决问题。
            你解决用户的问题时，要结合我给出的和用户有关的工单信息，帮助用户实现数据的统计和分析，最后不要用分点的形式给出方案。
            如果你认为用户的问题和资料没有关系，你就凭借自己的感觉，给出建议（不要分条）。
            如果涉及用户问到数据，一定要给出回答.
            资料：` +this.ans  },
                            { role: 'user', content: message }
                        ],
                        temperature: 0.3
                    };
                    fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'sk-VtITtLb4695UfulYd265iOrLtW823gZ5zc4dab0ZD5O11Nsy'
                        },
                        body: JSON.stringify(payload)
                    })
                        .then(res => res.json())
                        .then(data => {
                            clearInterval(dotI);
                            const resp = data.choices?.[0]?.message?.content || '抱歉，未收到有效回复。';
                            // 渲染回复
                            botDiv.innerHTML = `
          <div class="avatar-container">
            <img src="./02.png" alt="Kimi Avatar"width="50px" />
            <span class="username">智慧巡检助手</span>
          </div>
          <div class="message-content">${resp}</div>
        `;
                            container.scrollTop = container.scrollHeight;
                        })
                        .catch(err => {
                            clearInterval(dotI);
                            console.error('发生错误:', err);
                            botDiv.innerHTML = `
          <div class="avatar-container">
            <img src="./02.png" alt="Kimi Avatar"width="50px" />
            <span class="username">智慧巡检助手</span>
          </div>
          <div class="message-content">网络或服务器错误，请稍后再试。</div>
        `;
                        });
                }
            ,
                // 日期格式化
                formatDate(dateString) {

                    return dateString;
                },
                // 工单号格式化
                formatId(id) {
                    return id.toString();
                },

                handleClose(done) {
                    this.$confirm('确认关闭？')
                        .then(_ => {
                            done();
                        })
                        .catch(_ => {});
                }
            ,
                handleSelect(key, keyPath) {

                    this.activeIndex2 = key;
                    if(key<=7)
                    window.location.href = "http://localhost:7469/MaintenanceManage/0"+(key-1)+".html";
                    if(key==8)this.drawer=true;
                    if(key==9){


                        this.drawer01=true;

                    }
                    console.log(key, keyPath);
                },
                handleMenuItemClick(index) {
                    console.log('点击菜单:', index)
                    this.activeIndex1=index;
                    if(index==1){
                        window.location.href = "http://localhost:7469/MaintenanceManage/000.html";
                    }
                    else if(index==2){

                        window.location.href = "http://localhost:7469/MaintenanceManage/01.html";
                    }
                    else if(index==3){

                        window.location.href = "http://localhost:7469/MaintenanceManage/002.html";
                    }
                    else if(index==4){
                        window.location.href = "http://localhost:7469/MaintenanceManage/logIn.html";


                    }
                },
                fileList: [],
                handleRemove(file) {
                    // 从上传文件列表中移除
                    const fileList = this.$refs.upload.uploadFiles;
                    this.$refs.upload.uploadFiles = fileList.filter(item => item.uid !== file.uid);
                },
                handlePictureCardPreview(file) {
                    this.dialogImageUrl = file.url;
                    this.dialogVisible = true;
                },
                handleDownload(file) {
                    console.log(file);
                },

                submitRepairOrder(){

                    axios.post("http://localhost:7469/MaintenanceManage/repairOrder/insert",this.repairOrder).then((res) => {

                        alert("hello");

                    })
                    this.dialogVisible=false;
                }
            }
        }
    )
</script>


</html>