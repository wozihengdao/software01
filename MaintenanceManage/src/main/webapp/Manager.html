<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>设备维护管理系统</title>

    <!-- 引入依赖 -->
    <script src="js/axios-0.18.0.js"></script>
    <script src="js/vue.js"></script>
    <script src="element-ui/lib/index.js"></script>
    <link rel="stylesheet" href="element-ui/lib/theme-chalk/index.css">
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<style>
    /* 全局样式 */
    .el-container {
        height: 100vh;
        overflow: hidden;
    }

    /* 导航菜单 */
    .el-aside {
        background: #545c64 !important;
        box-shadow: 2px 0 6px rgba(0, 0, 0, 0.1);
    }

    .el-menu {
        border-right: none;
    }

    /* 个人信息模块 */
    .personal-container {
        display: flex;
        padding: 20px;
        gap: 20px;
        height: calc(100vh - 60px);
    }

    .personal-card {
        width: 320px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .avatar-img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 15px 0;
        border: 4px solid #fff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    /* 工单管理 */
    .create-button-group {
        margin: 15px 0;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .order-card {
        margin-top: 15px;
        transition: all 0.3s;
        border-radius: 8px;
    }

    /* 图表样式 */
    .chart-card {
        height: 360px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .chart-title {
        margin: 0 0 15px 15px;
        font-size: 16px;
        font-weight: 600;
    }

    /* 对话框样式 */
    .auto-assign-dialog {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .detail-dialog .el-descriptions {
        margin: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }

    .batch-notice {
        margin-bottom: 15px;
        color: #606266;
        font-size: 14px;
    }

    .template-info {
        line-height: 1.8;
        padding: 10px;
        border-radius: 4px;
        background-color: #f8f8f8;

        div {
            color: #606266;
            font-size: 14px;
        }
    }

    .el-alert--warning.is-light {
        margin: 10px 0;
        background-color: #fdf6ec;
    }
    /* 添加提示样式 */
    .template-status {
        margin: 15px 0;
        padding: 15px;
        background: #fdf6ec;
        border-radius: 4px;
    }

    .template-info {
        padding: 12px;
        background: #f8f8f9;
        border-radius: 4px;

        .template-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;

            .order-no {
                font-weight: 500;
                color: #303133;
            }
        }

        .equipment-info {
            color: #606266;
            font-size: 14px;
        }
    }
    /* 警告框样式 */
    .template-alert {
        .el-message-box__status.el-icon-warning {
            color: #E6A23C;
        }
        .el-message-box__title {
            color: #E6A23C;
        }
        background: #fdf6ec;
        border-color: #faecd8;
    }

    .stat-card1 {
        position: absolute;
        top:1vw;
        width: 13vw;
        left: 13vw;
        height: 18vw;
        background: white;
        border-radius: 8px;
        padding: 20px;
        flex: 1;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
    }
    .stat-card2 {
        position: absolute;
        top:1vw;
        left: 28.7vw;
        width: 13vw;
        height: 18vw;
        background: white;
        border-radius: 8px;
        padding: 20px;
        flex: 1;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
    }
    .stat-card3 {
        position: absolute;
        top:1vw;
        left: 67.2vw;
        height: 18vw;
        width: 13vw;
        background: white;
        border-radius: 8px;
        padding: 20px;
        flex: 1;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
    }
    .stat-card4 {
        position: absolute;
        top:1vw;
        left: 83vw;
        width: 13vw;
        height: 18vw;
        background: white;
        border-radius: 8px;
        padding: 20px;
        flex: 1;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
    }
    .color-block {
        width: 70px;
        height: 70px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
    }

    .blue { background-color: #409EFF; }
    .green { background-color: #67C23A; }
    .orange { background-color: #E6A23C; }
    .yellow { background-color: #E6C23C; }

    .stat-number {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-title {
        font-size: 14px;
        color: #606266;
    }

    /* 在现有样式最后添加 */
    .order-stats-container {
        position: absolute;
        top: 8vw;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        padding: 20px;
        width: 84%;
        height: 75vh;
    }

    .stat-card5 {
        position: absolute;
        top:14vw;
        height: auto;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        flex: 1;
    }
    .stat-card6 {
        position: absolute;
        top:14vw;
        left: 61.3vw;
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        flex: 1;
    }
    .stat-content{
        position: absolute;
        top:1vw;
        left: 6vw;
        width: calc(100% - 90px); /* 留出颜色块空间 */
    }
    .detail-list {
        margin-top: 15px;
        margin-left: -90px;
        border-top: 1px solid #ebeef5;
        padding-top: 10px;
    }

    .detail-item {
        display: flex;
        justify-content: flex-start !important;
        font-size: 12px;
        color: #909399;
        margin: 30px 0;
        gap: 8px;  /* 固定间距代替比例间距 */

    }
    /* 数字与标题间距调整 */
    .stat-number {
        margin-bottom: 0.3vw !important;
        font-size: 1.8rem !important;  /* 适当缩小数字大小 */
    }

    .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 9px;
    }

    .healthy { background: #67C23A; }
    .warning { background: #E6A23C; }
    .error { background: #F56C6C; }

    .color-block{
        position: absolute;
        top:1vw;
    }
    #line-chart-container {
        width: 67%;
        height: 70%;
    }

    #pie-chart-container {
        width: 25%;
        height: 70%;
    }

    @media (max-width: 1200px) {
        .order-stats-container {
            flex-direction: column;
            height: auto;
        }

        #line-chart-container,
        #pie-chart-container {
            width: 100%;
            height: 400px;
        }
    }
    /* 新增个人信息模块样式 */
    .personal-info-card {
        position: absolute;
        left: 44vw;
        top:-14px;
        width: 350px;
        height: 22.5vw;
        margin-left: 20px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    .info-item {
        margin: 8px 28px;
        line-height: 15px;
    }
    .info-label { color: #909399; margin-right: 10px; }
    .info-content { color: #606266; }
    .avatar-img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 15px auto;
        display: block;
        border: 4px solid #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /*联系我们*/

    .contact-modules {
        display: flex;
        justify-content: space-around;
        gap: 20px;
        padding: 20px;
        height: calc(100vh - 60px);
    }

    .contact-card {
        flex: 1;
        width: 460px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transition: transform 0.3s;
    }

    .contact-card:hover {
        transform: translateY(-5px);
    }

    .contact-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        margin: 0 auto 15px !important;
        display: block;
    }

    .contact-info {
        text-align: center;
        padding: 15px;
    }

    .contact-name {
        font-size: 18px;
        font-weight: 600;
        color: #303133;
        margin-bottom: 8px;
    }

    .contact-position {
        color: #409EFF;
        font-size: 14px;
        margin-bottom: 12px;
    }

    .contact-detail {
        font-size: 14px;
        color: #606266;
        line-height: 1.6;
    }

    @media (max-width: 992px) {
        .contact-modules {
            flex-direction: column;
            align-items: center;
        }
        .contact-card {
            width: 100%;
            max-width: 500px;
        }
    }

</style>

<body>
<div id="app">
    <el-container>
        <!-- 左侧导航菜单 -->
        <el-aside width="200px" style="background-color: #545c64; height: 100vh">
            <el-menu
                    default-active="1"
                    @select="handleMenuSelect"
                    background-color="#545c64"
                    text-color="#fff"
                    active-text-color="#ffd04b">
                <el-menu-item-group title="主菜单">
                    <el-menu-item index="1"><i class="el-icon-moon"></i>首页</el-menu-item>
                    <el-menu-item index="2"><i class="el-icon-menu"></i>工单管理</el-menu-item>
                    <el-menu-item index="3"><i class="el-icon-phone"></i>联系我们</el-menu-item>
                    <el-menu-item index="4"><i class="el-icon-switch-button"></i>退出登录</el-menu-item>
                </el-menu-item-group>
            </el-menu>
        </el-aside>

        <!-- 右侧主内容区 -->
        <el-container>
            <!-- 个人信息模块-->
            <div v-show="activeIndex === '1'" class="personal-container">
                <!-- 统计卡片 -->
                <div class="dashboard-container">
                    <!-- 用户访问量 -->
                    <div class="stat-card1">
                        <div class="color-block blue">
                            <i class="el-icon-user"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.staff.total }}</div>
                            <div class="stat-title">员工数量</div>
                            <div class="detail-list">
                                <div class="detail-item">
                                    <span><span class="status-dot healthy"></span>维修工程师</span>
                                    <span>{{ stats.staff.engineers }}</span>
                                </div>
                                <div class="detail-item">
                                    <span><span class="status-dot healthy"></span>管理人员</span>
                                    <span>{{ stats.staff.managers }}</span>
                                </div>
                                <div class="detail-item">
                                    <span><span class="status-dot healthy"></span>其他人员</span>
                                    <span>{{ stats.staff.others }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统消息 -->
                    <div class="stat-card2">
                        <div class="color-block green">
                            <i class="el-icon-message"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.messages.total }}</div>
                            <div class="stat-title">系统消息</div>
                            <div class="detail-list">
                                <div class="detail-item">
                                    <span><span class="status-dot warning"></span>未读消息</span>
                                    <span>{{ stats.messages.unread }}</span>
                                </div>
                                <div class="detail-item">
                                    <span><span class="status-dot healthy"></span>已读消息</span>
                                    <span>{{ stats.messages.read }}</span>
                                </div>
                                <div class="detail-item">
                                    <span><span class="status-dot error"></span>已读消息</span>
                                    <span>{{ stats.messages.urgent }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 工单数量 -->
                    <div class="stat-card3">
                        <div class="color-block orange">
                            <i class="el-icon-document"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.orders.total }}</div>
                            <div class="stat-title">工单数量</div>
                            <div class="detail-list">
                                <div class="detail-item">
                                    <span><span class="status-dot healthy"></span>已完成</span>
                                    <span>{{ stats.orders.completed }}</span>
                                </div>
                                <div class="detail-item">
                                    <span><span class="status-dot warning"></span>进行中</span>
                                    <span>{{ stats.orders.processing }}</span>
                                </div>
                                <div class="detail-item">
                                    <span><span class="status-dot error"></span>超时</span>
                                    <span>{{ stats.orders.overdue }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 运行设备 -->
                    <div class="stat-card4">
                        <div class="color-block yellow">
                            <i class="el-icon-monitor"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-number">{{ stats.devices.total }}</div>
                            <div class="stat-title">运行设备数量</div>
                            <div class="detail-list">
                                <div class="detail-item">
                                    <span><span class="status-dot healthy"></span>正常</span>
                                    <span>{{ stats.devices.normal }}</span>
                                </div>
                                <div class="detail-item">
                                    <span><span class="status-dot warning"></span>预警</span>
                                    <span>{{ stats.devices.warning }}</span>
                                </div>
                                <div class="detail-item">
                                    <span><span class="status-dot error"></span>故障</span>
                                    <span>{{ stats.devices.fault }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 工单统计容器 -->
                <div class="order-stats-container">
                    <!-- 折线图 -->
                    <div class="stat-card5" id="line-chart-container">
                        <div id="container01" style="height: 100%"></div>
                    </div>

                    <!-- 饼图 -->
                    <div class="stat-card6" id="pie-chart-container">
                        <div id="container02" style="height: 100%"></div>
                    </div>
                </div>

                <!-- 个人信息模块 -->
                <el-card class="personal-info-card">
                    <h1 style="text-align: center;">本月最优员工</h1>
                    <img src="1.png" class="avatar-img">
                    <div style="padding:14px">
                        <div class="info-item">
                            <span class="info-label">姓名：</span>
                            <span class="info-content">{{ engineer.name }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">工号：</span>
                            <span class="info-content">{{ engineer.id }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">工种：</span>
                            <span class="info-content">{{ engineer.type === '1' ? '维修工程师' : '其他' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">手机号:</span>
                            <span class="info-content">{{ engineer.phone }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">技能：</span>
                            <span class="info-content">{{ engineer.skills[0] }} </span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">邮箱：</span>
                            <span class="info-content">123456789@qq.com</span>
                        </div>
                    </div>
                </el-card>

            </div>
            <!-- 工单管理模块 -->
            <div v-show="activeIndex === '2'" style="width:100%">
                <el-header style="border-bottom: 1px solid #e6e6e6">
                    <!-- 工单类型切换 -->
                    <el-radio-group v-model="activeType" size="medium" @change="handleTypeChange">
                        <el-radio-button
                                v-for="type in orderTypes"
                                :key="type.value"
                                :label="type.value">
                            {{ type.label }}
                        </el-radio-button>
                    </el-radio-group>

                    <!-- 新建保养工单按钮 -->
                    <div class="create-button-group">
                        <el-button
                                v-if="['maintain','service','patrol','monitor','spare'].includes(activeType)"
                                type="primary"
                                :disabled="selectedOrders.length === 0"
                                @click="showBatchAssignDialog"
                                style="margin-left:10px">
                            <i class="el-icon-s-operation"></i> 批量派单（{{ selectedOrders.length }}）
                        </el-button>
                        <el-button
                                v-if="activeType === 'service'"
                                type="primary"
                                @click="showCreateDialog">
                            <i class="el-icon-plus"></i> 新建保养工单
                        </el-button>
                        <!-- 新增自动自动生成工单按钮 -->
                        <el-button
                                v-if="activeType === 'service'"
                                type="warning"
                                @click="showAutoAssignConfig('service')"
                                style="margin-left:10px">
                            <i class="el-icon-alarm-clock"></i> 自动生成工单
                        </el-button>

                        <!-- 新增：巡检工单按钮 -->
                        <el-button
                                v-if="activeType === 'patrol'"
                                type="primary"
                                @click="showCreateDialog">
                            <i class="el-icon-plus"></i> 新建巡检工单
                        </el-button>
                        <el-button
                                v-if="activeType === 'patrol'"
                                type="warning"
                                @click="showAutoAssignConfig('patrol')"
                                style="margin-left:10px">
                            <i class="el-icon-alarm-clock"></i> 自动生成工单
                        </el-button>
                        <!-- 新增：监测工单按钮 -->
                        <el-button
                                v-if="activeType === 'monitor'"
                                type="primary"
                                @click="showCreateDialog">
                            <i class="el-icon-plus"></i> 新建监测工单
                        </el-button>
                        <el-button
                                v-if="activeType === 'monitor'"
                                type="warning"
                                @click="showAutoAssignConfig('monitor')"
                                style="margin-left:10px">
                            <i class="el-icon-alarm-clock"></i> 自动生成工单
                        </el-button>
                        <!-- 新增：备件工单按钮 -->
                        <el-button
                                v-if="activeType === 'spare'"
                                type="primary"
                                @click="showCreateDialog">
                            <i class="el-icon-plus"></i> 新建备件工单
                        </el-button>
                        <el-button
                                v-if="activeType === 'spare'"
                                type="warning"
                                @click="showAutoAssignConfig('spare')"
                                style="margin-left:10px">
                            <i class="el-icon-alarm-clock"></i> 自动生成工单
                        </el-button>
                    </div>
                </el-header>
                <!-- 添加周期设置对话框 -->
                <el-dialog
                        title="自动生成工单配置"
                        :visible.sync="autoAssignVisible"
                        width="500px">
                    <el-form label-width="120px">
                        <!-- 启用开关 -->
                        <el-form-item label="启用自动生成">
                            <el-switch
                                    v-model="autoEnable"
                                    active-text="开启"
                                    active-color="#1E90FF"
                                    inactive-text="关闭"
                                    inactive-color="#ff4949">
                            </el-switch>
                        </el-form-item>

                        <template v-if="autoEnable">
                            <!-- 周期设置 -->
                            <el-form-item label="生成周期" required>
                                <el-select
                                        v-model="selectedCycle"
                                        placeholder="请选择生成周期"
                                        style="width:100%">
                                    <el-option
                                            v-for="item in cycleOptions"
                                            :key="item.value"
                                            :label="item.label"
                                            :value="item.value">
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            <!-- 模板状态提示 -->
                            <div class="template-status" v-if="!currentTemplate">
                                <el-alert
                                        title="尚未设置模板"
                                        description="请先创建并标记模板工单"
                                        type="warning"
                                        :closable="false"
                                        show-icon>
                                    <div slot="title">
                                        <i class="el-icon-warning" style="color: #E6A23C;"></i>
                                        <span style="color: #E6A23C;">尚未设置模板</span>
                                    </div>
                                    <span style="color: #606266;">请先创建并标记模板工单</span>
                                </el-alert>
                            </div>
                            <!-- 模板信息展示 -->
                            <el-form-item label="当前模板" v-else>
                                <div class="template-info">
                                    <div class="template-meta">
                                        <span class="order-no">{{ currentTemplate.orderNo }}</span>
                                        <el-tag type="info" size="mini">创建于 {{ formatTime(currentTemplate.createTime) }}</el-tag>
                                    </div>
                                    <div class="equipment-info">
                                        {{ currentTemplate.equipmentType }} @ {{ currentTemplate.stop }}
                                    </div>
                                </div>
                            </el-form-item>
                        </template>
                    </el-form>
                    <span slot="footer">
        <el-button @click="autoAssignVisible = false">取消</el-button>
        <el-button
                type="primary"
                :disabled="autoEnable && (!selectedCycle || !currentTemplate)"
                @click="saveAutoConfig">
            保存配置
        </el-button>
    </span>
                </el-dialog>
                <!-- 工单表格 -->
                <el-main>
                    <el-card class="order-card">
                        <el-table
                                :data="filteredOrders"
                                stripe
                                @selection-change="handleSelectionChange"
                                style="width: 100%"
                                v-loading="loading">
                            <el-table-column type="selection" width="55" fixed></el-table-column>
                            <!-- 固定列：工单编号 -->
                            <el-table-column
                                    label="工单编号"
                                    prop="orderNo"
                                    width="180"
                                    fixed>
                            </el-table-column>

                            <!-- 动态列 -->
                            <template v-for="(col, index) in dynamicColumns">
                                <el-table-column
                                        :key="index"
                                        :label="col.label"
                                        :prop="col.prop"
                                        :width="col.width">
                                </el-table-column>
                            </template>

                            <!-- 状态列 -->
                            <el-table-column
                                    v-if="activeType != 'repair'"
                                    label="状态" width="120">
                                <template v-slot="scope">
                                    <el-tag :type="statusStyle[scope.row.status]" size="medium">
                                        {{ statusText[scope.row.status] }}
                                    </el-tag>
                                </template>
                            </el-table-column>

                            <!-- 操作列 -->
                            <el-table-column label="操作" width="180" fixed="right">
                                <template v-slot="scope">
                                    <div style="display: flex; gap: 8px">
                                        <el-button
                                                type="text"
                                                @click="handleDetail(scope.row)">
                                            详情
                                        </el-button>
                                        <template
                                                v-if="['maintain','service','patrol','monitor','spare'].includes(activeType) && scope.row.status === 0">
                                            <el-button
                                                    type="text"
                                                    style="color:#67C23A"
                                                    @click="showAssignDialog(scope.row)">
                                                派单
                                            </el-button>
                                        </template>
                                    </div>
                                </template>
                            </el-table-column>
                        </el-table>

                        <!-- 分页组件 -->
                        <el-pagination
                                background
                                layout="total, prev, pager, next"
                                :total="totalFiltered"
                                :page-size="pageSize"
                                :current-page="currentPage"
                                @current-change="handlePageChange"
                                style="margin-top: 20px">
                        </el-pagination>
                    </el-card>
                </el-main>

                <!-- 新建保养工单对话框 -->
                <el-dialog
                        title="新建保养工单"
                        :visible.sync="createDialogVisible"
                        width="600px">
                    <el-form
                            :model="newOrder"
                            :rules="orderRules"
                            ref="orderForm"
                            label-width="100px">
                        <el-form-item label="所属车站" prop="stop">
                            <el-select
                                    v-model="newOrder.stop"
                                    filterable
                                    placeholder="请选择车站"
                                    style="width: 100%">
                                <el-option
                                        v-for="station in stationList"
                                        :key="station.id"
                                        :label="`${station.id} - ${station.name}`"
                                        :value="station.id">
                                    <span style="float: left">{{ station.id }}</span>
                                    <span style="float: right; color: #8492a6; font-size: 13px">
                                        {{ station.name }}
                                    </span>
                                </el-option>
                            </el-select>
                        </el-form-item>

                        <el-form-item label="设备选择" prop="equipmentId">
                            <el-select
                                    v-model="selectedEquipment"
                                    filterable
                                    placeholder="请选择设备"
                                    @change="handleEquipmentChange"
                                    style="width: 100%">
                                <el-option
                                        v-for="item in equipmentList"
                                        :key="item.id"
                                        :label="`${item.id} - ${item.name}`"
                                        :value="item">
                                    <span style="float: left">{{ item.id }}</span>
                                    <span style="float: right; color: #8492a6; font-size: 13px">
                                        {{ item.name }}（{{ item.type }}）
                                    </span>
                                </el-option>
                            </el-select>
                        </el-form-item>

                        <el-form-item label="设备名称">
                            <el-input v-model="equipmentInfo.name" disabled></el-input>
                        </el-form-item>

                        <el-form-item label="设备类型">
                            <el-input v-model="equipmentInfo.type" disabled></el-input>
                        </el-form-item>
                        <el-form-item label="模板设置" v-if="autoEnable">
                            <el-checkbox v-model="newOrder.isTemplate">设为自动生成模板</el-checkbox>
                            <el-tooltip content="勾选后此工单将作为自动生成模板使用" placement="top">
                                <i class="el-icon-info"></i>
                            </el-tooltip>
                        </el-form-item>
                    </el-form>

                    <span slot="footer" class="dialog-footer">
                        <el-button @click="createDialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="createOrder">确 定</el-button>
                    </span>
                </el-dialog>

                <!-- 派单对话框 -->
                <el-dialog
                        :title="isBatchAssign ? '批量派发工单' : '选择工程师'"
                        :visible.sync="assignDialogVisible"
                        width="30%">
                    <div v-if="isBatchAssign" class="batch-notice">
                        即将派发 {{ selectedOrders.length }} 个工单
                    </div>
                    <el-select
                            v-model="selectedEngineer"
                            placeholder="请选择工程师"
                            filterable
                            style="width: 100%">
                        <el-option
                                v-for="engineer in engineers"
                                :key="engineer.id"
                                :label="engineer.name"
                                :value="engineer.id">
                            <span style="float: left">{{ engineer.name }}</span>
                            <span style="float: right; color: #8492a6; font-size: 13px">
                                {{ engineer.id}}
                            </span>
                        </el-option>
                    </el-select>
                    <span slot="footer" class="dialog-footer">
                        <el-button @click="assignDialogVisible = false">取 消</el-button>
                        <el-button type="primary" @click="assignOrder">确 定</el-button>
                    </span>
                </el-dialog>

                <!-- 工单详情对话框 -->
                <el-dialog
                        :title="`工单详情 - ${currentDetail?.orderNo}`"
                        :visible.sync="detailDialogVisible"
                        width="800px"
                        class="detail-dialog">
                    <el-descriptions
                            :column="2"
                            border
                            v-if="currentDetail"
                            style="margin: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.06)">

                        <!-- 通用字段 -->
                        <el-descriptions-item label="工单类型" style="font-weight: 500; color: #303133;">
                            工单类型：{{ orderTypes.find(t => t.value === activeType)?.label }}
                        </el-descriptions-item>
                        <el-descriptions-item label="当前状态" style="font-weight: 500; color: #303133;">
                            <el-tag
                                    :type="statusStyle[currentDetail.status]"
                                    size="small"
                                    style="font-size: 14px; vertical-align: middle;">
                                {{ statusText[currentDetail.status] }}
                            </el-tag>
                        </el-descriptions-item>
                        <el-descriptions-item label="所属车站" :span="2">
                            <span style="font-size: 14px; color: #606266;">{{ currentDetail.stop || '未填写' }}</span>
                        </el-descriptions-item>
                        <el-descriptions-item label="创建时间" :span="2">
                            <span style="font-size: 14px; color: #606266;">{{ formatTime(currentDetail.createTime)
                                }}</span>
                        </el-descriptions-item>

                        <!-- 动态字段 -->
                        <template v-if="activeType === 'repair'">
                            <el-descriptions-item label="故障设备ID" :span="2">
                                <span style="font-size: 14px; color: #606266;">{{ currentDetail.faultyEquipmentId || '未填写'
                                    }}</span>
                            </el-descriptions-item>
                            <el-descriptions-item label="故障类型" :span="2">
                                <span style="font-size: 14px; color: #606266;">{{ currentDetail.faultyType || '未填写'
                                    }}</span>
                            </el-descriptions-item>
                            <el-descriptions-item label="紧急程度" :span="2">
                                <el-tag
                                        :type="getUrgencyStyle(currentDetail.faultyGrade)"
                                        size="small"
                                        class="urgency-tag"
                                        style="font-size: 14px; margin-left: 0;">
                                    {{ getUrgencyText(currentDetail.faultyGrade) || '未填写' }}
                                </el-tag>
                            </el-descriptions-item>
                            <el-descriptions-item label="故障描述" :span="2">
                                <div class="fault-description"
                                     style="margin: 12px 0; padding: 16px; border-radius: 8px;">
                    <span style="font-size: 14px; color: #606266; line-height: 1.8;">
                        {{ currentDetail.faultyDescription || '无故障描述' }}
                    </span>
                                </div>
                            </el-descriptions-item>
                        </template>

                        <template v-if="['maintain', 'service', 'patrol'].includes(activeType)">
                            <el-descriptions-item label="负责工程师" :span="2">
                                <span style="font-size: 14px; color: #606266;">{{ currentDetail.engineerName || '未分配'
                                    }}</span>
                            </el-descriptions-item>
                            <el-descriptions-item label="计划时间" :span="2">
                                <span style="font-size: 14px; color: #606266;">{{ formatTime(currentDetail.planTime)
                                    }}</span>
                            </el-descriptions-item>
                        </template>

                        <template v-if="['check', 'spare', 'service'].includes(activeType)">
                            <el-descriptions-item label="设备类型" :span="2">
                                <span style="font-size: 14px; color: #606266;">{{ currentDetail.EquipmentType || '未知类型'
                                    }}</span>
                            </el-descriptions-item>
                            <el-descriptions-item label="设备ID" :span="2">
                                <span style="font-size: 14px; color: #606266;">{{ currentDetail.EquipmentId || '未填写'
                                    }}</span>
                            </el-descriptions-item>
                        </template>

                        <!-- 图片展示 -->
                        <el-descriptions-item label="相关图片" :span="2" style="padding-top: 20px;">
                            <div class="image-preview-wrapper"
                                 style="display: flex; gap: 12px; padding: 16px; border-radius: 8px;">
                                <template v-if="activeType === 'repair'">
                                    <el-image
                                            v-if="currentDetail.picture"
                                            :src="currentDetail.picture"
                                            :preview-src-list="[currentDetail.picture]"
                                            style="width: 160px; height: 120px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1)">
                                        <div slot="tip" class="image-label" style="border-radius: 0 0 6px 6px;">
                                            故障图片
                                        </div>
                                    </el-image>
                                </template>

                                <template v-if="['check', 'spare', 'service'].includes(activeType)">
                                    <el-image
                                            v-if="currentDetail.oldPicture"
                                            :src="currentDetail.oldPicture"
                                            :preview-src-list="[currentDetail.oldPicture, currentDetail.newPicture]"
                                            style="width: 160px; height: 120px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1)">
                                        <div slot="tip" class="image-label" style="border-radius: 0 0 6px 6px;">维修前
                                        </div>
                                    </el-image>
                                    <el-image
                                            v-if="currentDetail.newPicture"
                                            :src="currentDetail.newPicture"
                                            :preview-src-list="[currentDetail.oldPicture, currentDetail.newPicture]"
                                            style="width: 160px; height: 120px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0.1)">
                                        <div slot="tip" class="image-label" style="border-radius: 0 0 6px 6px;">维修后
                                        </div>
                                    </el-image>
                                </template>
                            </div>
                        </el-descriptions-item>

                        <!-- 附加数据 -->
                        <el-descriptions-item label="补充信息" :span="2" style="padding-top: 20px;">
                            <div style="font-size: 14px; color: #606266; line-height: 1.8;">
                                {{ currentDetail.data || '无附加信息' }}
                            </div>
                        </el-descriptions-item>
                    </el-descriptions>
                </el-dialog>
            </div>

            <!-- 联系我们模块 -->
            <div v-show="activeIndex === '3'">
                <div class="contact-modules">
                    <!-- 技术支持模块 -->
                    <el-card class="contact-card">
                        <img src="./img/一衡头像.jpg" class="contact-avatar">
                        <div class="contact-info">
                            <h2 class="contact-name">张一衡</h2>
                            <div class="contact-position">技术支持</div>
                            <div class="contact-detail">
                                <p>邮箱：support@railmaintain.com</p>
                                <p>7×24小时在线支持</p>
                            </div>
                        </div>
                    </el-card>

                    <!-- 客户服务模块 -->
                    <el-card class="contact-card">
                        <img src="./img/宇恒头像.jpg" class="contact-avatar ">
                        <div class="contact-info">
                            <h2 class="contact-name">刘宇恒</h2>
                            <div class="contact-position">技术支持</div>
                            <div class="contact-detail">
                                <p>邮箱：support@railmaintain.com</p>
                                <p>7×24小时在线支持</p>
                            </div>
                        </div>
                    </el-card>

                    <!-- 紧急联系模块 -->
                    <el-card class="contact-card">
                        <img src="./img/阿伟头像.jpg" class="contact-avatar">
                        <div class="contact-info">
                            <h2 class="contact-name">孙艺伟</h2>
                            <div class="contact-position">运维</div>
                            <div class="contact-detail">
                                <p>邮箱：support@railmaintain.com</p>
                                <p>应急预案联系人</p>
                            </div>
                        </div>
                    </el-card>
                </div>
            </div>
        </el-container>
    </el-container>
</div>

<script>
    function initOrderStats() {
        // 初始化折线图
        const initLineChart = () => {
            const echarts = window.echarts;
            const dom = document.getElementById('container01');
            if (!dom) return;

            const myChart = echarts.init(dom, null, {
                renderer: 'canvas',
                useDirtyRect: false
            });

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6a7985'
                        }
                    }
                },
                title: {
                    text: '各项工单周期情况汇总',
                    left: 'center'
                },
                legend: {
                    data: ['保养单', '备件单','巡检单', '检测单','维修单'],
                    top: 30
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
                    boundaryGap: false
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        name: '维修单',
                        type: 'line',
                        stack: 'Total',
                        areaStyle: {},
                        label: {
                            show: true,
                            position: 'top'
                        },
                        data: [10, 14, 12, 10, 7, 12, 13]
                    },
                    {
                        name: '保养单',
                        type: 'line',
                        stack: 'Total',
                        areaStyle: {},
                        label: {
                            show: true,
                            position: 'top'
                        },
                        data: [9, 12, 14, 16, 16, 14, 12]
                    },
                    {
                        name: '备件单',
                        type: 'line',
                        stack: 'Total',
                        areaStyle: {},
                        label: {
                            show: true,
                            position: 'top'
                        },
                        data: [12, 12, 13, 14, 18, 12, 9]
                    },
                    {
                        name: '巡检单',
                        type: 'line',
                        stack: 'Total',
                        areaStyle: {},
                        label: {
                            show: true,
                            position: 'top'
                        },
                        data: [12, 17, 11, 13, 17, 13, 12]
                    },
                    {
                        name: '检测单',
                        type: 'line',
                        stack: 'Total',
                        areaStyle: {},
                        label: {
                            show: true,
                            position: 'top'
                        },
                        data: [12, 12, 17, 14, 18, 20, 16]
                    }
                ]
            };

            myChart.setOption(option);
            window.addEventListener('resize', myChart.resize);
        };

        // 初始化饼图
        const initPieChart = () => {
            const echarts = window.echarts;
            const dom02 = document.getElementById('container02');
            if (!dom02) return;

            const myChart02 = echarts.init(dom02, null, {
                renderer: 'canvas',
                useDirtyRect: false
            });

            const option02 = {
                title: {
                    text: '工程师工单完成情况分析',
                    subtext: '',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item'
                },
                legend: {
                    top: '85%',
                    left: 'center'
                },
                series: [
                    {
                        center: ['50%', '45%'],
                        name: '详细信息',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        padAngle: 5,
                        itemStyle: {
                            borderRadius: 10
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 40,
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: [
                            { value: 30, name: '超时完成' },
                            { value: 150, name: '按时完成' },
                            { value: 50, name: '待完成' },
                            { value: 30, name: '超时未完成' },
                        ]
                    }
                ]
            };

            myChart02.setOption(option02);
            window.addEventListener('resize', myChart02.resize);
        };

        // 初始化数据请求
        const fetchData = () => {
            axios.post("http://localhost:7469/MaintenanceManage/repairOrder/allOrder", storage.get('user').username)
                .then((res) => {
                    // 这里可以添加数据处理逻辑
                    console.log('完整工单数据:', res.data);
                })
                .catch(error => {
                    console.error('数据请求失败:', error);
                });
        };

        // 执行初始化
        initLineChart();
        initPieChart();
        fetchData();
    }
    new Vue({
        el: '#app',
        data() {
            return {
                // 导航状态
                activeIndex: '1',
                activeType: 'repair',

                // 新增统计配置项
                CHART_CONFIG: {
                    lineChart: { width: 1000, height: 500 },
                    pieChart: { width: 500, height: 500 }
                },
                COLOR_SCHEME: [
                    '#5470C6', '#91CC75', '#FAC858',
                    '#EE6666', '#73C0DE'
                ],
                // 工单类型配置
                orderTypes: [
                    {value: 'repair', label: '报修工单'},
                    {value: 'maintain', label: '维修工单'},
                    {value: 'service', label: '保养工单'},
                    {value: 'patrol', label: '巡检工单'},
                    {value: 'monitor', label: '监测工单'},
                    {value: 'spare', label: '备件工单'}
                ],
                stats: {
                    staff: {
                        total: 18,
                        engineers: 12,
                        managers: 4,
                        others: 2
                    },
                    messages: {
                        total: 12,
                        unread: 3,
                        read: 7,
                        urgent: 2
                    },
                    orders: {
                        total: 23,
                        completed: 15,
                        processing: 5,
                        overdue: 3
                    },
                    devices: {
                        total: 23,
                        normal: 18,
                        warning: 3,
                        fault: 2
                    }
                },
                // 数据存储
                allOrders: [],      // 全部工单数据
                engineers: [],      // 工程师列表
                currentDetail: null,// 当前查看的工单详情

                // 分页配置
                pageSize: 10,
                currentPage: 1,

                // 状态控制
                loading: false,
                assignDialogVisible: false,
                detailDialogVisible: false,
                createDialogVisible: false,

                // 临时数据
                selectedEngineer: null,
                currentOrder: null,

                engineerMap: {}, // 新增工程师ID-姓名映射
                // 完善工程师个人信息
                engineer: {
                    name: '王大帅',
                    id: '2222',
                    type: '1', // 1表示维修工程师
                    phone: '138-1234-5678',
                    workYears: 5,
                    email: 'wangdali@railway.com',
                    skills: ['设备维修', '机械调试', '电气控制', '故障诊断'],
                    performance: 4.8,
                    department: '设备维护一部',
                    position: '高级维修工程师',
                    certificate: '特种设备作业证-XJ12345'
                },
                // 保养工单相关数据
                stationList: [],         // 车站列表
                equipmentList: [],       // 设备列表
                selectedEquipment: null, // 当前选中设备
                equipmentInfo: {         // 设备展示信息
                    name: '',
                    type: ''
                },
                newOrder: {              // 新工单表单数据
                    stop: '',
                    equipmentId: '',
                    equipmentType: '',
                    isTemplate: false, // 是否作为模板
                },
                orderRules: {            // 表单验证规则
                    stop: [{required: true, message: '请选择车站', trigger: 'change'}],
                    equipmentId: [{required: true, message: '请选择设备', trigger: 'change'}]
                },
                autoAssignVisible: false,
                currentAssignType: '',
                selectedCycle: null,
                cycleOptions: [
                    {value: 7, label: '每周自动生成工单'},
                    {value: 14, label: '每两周自动生成工单'},
                    {value: 30, label: '每月自动生成工单'},
                    {value: 60, label: '每季度自动生成工单'}
                ],
                autoConfigs: {},
                selectedOrders: [],
                isBatchAssign: false,
                batchOrders: [],
                currentTemplate: null, // 当前生效模板
                autoEnable: false,     // 是否启用自动生成
                stationMap: {}, // 车站ID-名称映射
                orderTypeMapping: {
                    service: 1,
                    patrol: 2,
                    monitor: 3,
                    spare: 4
                }
            }
        },
        mounted() {
            initOrderStats();
        },
        computed: {
            /** 动态列配置 */
            dynamicColumns() {
                const config = {
                    repair: [
                        {label: '所属车站', prop: 'stop', width: 120},
                        {label: '设备编号', prop: 'faultyEquipmentId', width: 180},
                        {label: '故障类型', prop: 'faultyEquipmentType', width: 180},
                        {label: '上报时间', prop: 'reportTime', width: 180}
                    ],
                    maintain: [
                        {label: '负责人', prop: 'engineerName', width: 120},
                        {label: '计划时间', prop: 'planTime', width: 200}
                    ],
                    service: [
                        {label: '设备类型', prop: 'EquipmentType', width: 120},
                        {label: '保养时间', prop: 'planTime', width: 200},
                        {label: '负责人', prop: 'engineerName', width: 120},

                    ],
                    patrol: [
                        {label: '所属车站', prop: 'stop', width: 120},
                        {label: '设备编号', prop: 'EquipmentId', width: 180},
                        {label: '设备类型', prop: 'EquipmentType', width: 180},
                        {label: '上报时间', prop: 'planTime', width: 180},
                        {label: '负责人', prop: 'engineerName', width: 120},

                    ],
                    monitor: [
                        {label: '所属车站', prop: 'stop', width: 120},
                        {label: '设备编号', prop: 'EquipmentId', width: 180},
                        {label: '设备类型', prop: 'EquipmentType', width: 180},
                        {label: '上报时间', prop: 'planTime', width: 180},
                        {label: '负责人', prop: 'engineerName', width: 120},

                    ],
                    spare: [
                        {label: '所属车站', prop: 'stop', width: 120},
                        {label: '设备编号', prop: 'EquipmentId', width: 180},
                        {label: '设备类型', prop: 'EquipmentType', width: 180},
                        {label: '上报时间', prop: 'planTime', width: 180},
                        {label: '负责人', prop: 'engineerName', width: 120},
                    ]
                }
                return config[this.activeType] || []
            },

            /** 分页数据 */
            filteredOrders() {
                const start = (this.currentPage - 1) * this.pageSize
                return this.allOrders.slice(start, start + this.pageSize)
            },

            /** 分页总数 */
            totalFiltered() {
                return this.allOrders.length
            },

            /** 状态显示配置 */
            statusText() {
                return {0: '待处理', 1: '进行中', 2: '已完成', 3: '已关闭'}
            },
            statusStyle() {
                return {0: 'warning', 1: 'primary', 2: 'success', 3: 'info'}
            },

            /** 紧急程度文本映射 */
            getUrgencyText() {
                return level => ['一般', '紧急', '特急'][level] || '未知'
            },

            /** 紧急程度样式映射 */
            getUrgencyStyle() {
                return level => ['', 'warning', 'danger'][level] || ''
            }
        },
        watch: {
            /** 工单类型变化监听 */
            activeType() {
                this.currentPage = 1
                this.loadOrders()
            }
        },
        methods: {
            handleResize() {
                if (this.myChart) {
                    this.myChart.resize();
                }
                if (this.myChart02) {
                    this.myChart02.resize();
                }
            },
            handleSelectionChange(selection) {
                this.selectedOrders = selection;
            },
            showBatchAssignDialog() {
                if (this.selectedOrders.length === 0) {
                    this.$message.warning('请先选择要派发的工单');
                    return;
                }
                this.batchOrders = [...this.selectedOrders];
                this.isBatchAssign = true;
                this.assignDialogVisible = true;
            },
            // 自动获取最新模板
            async loadLatestTemplate() {
                try {
                    // 确保请求路径与后端接口匹配
                    const typeMapping = {
                        service: 'upkeepOrder',
                        patrol: 'patrolOrder',
                        monitor: 'checkOrder',
                        spare: 'spareOrder'
                    };

                    const res = await axios.get(
                        `http://localhost:7469/MaintenanceManage/${typeMapping[this.currentAssignType]}/getLatestTemplate`
                    );

                    // 添加响应数据校验
                    if (res.data && res.data.code === 200) {
                        this.currentTemplate = this.formatOrderData(res.data.data);
                    } else {
                        this.currentTemplate = null;
                    }
                } catch (error) {
                    console.error('模板加载失败:', error);
                    this.currentTemplate = null;
                }
            },
            // 新增配置加载方法
            async loadAutoConfigs() {
                try {
                    const res = await axios.get('http://localhost:7469/MaintenanceManage/timeSel/selectAll');
                    this.autoConfigs = res.data.reduce((configs, item) => {
                        const typeMap = {1: 'service', 2: 'patrol', 3: 'monitor', 4: 'spare'};
                        configs[typeMap[item.orderType]] = {
                            enable: item.day > 0,
                            cycle: item.day,
                            templateId: item.templateOrderId // 直接使用配置中的模板ID
                        };
                        return configs;
                    }, {});
                } catch (error) {
                    console.error('配置加载失败:', error);
                }
            },

            //工程师列表加载方法
            async loadEngineers() {
                try {
                    const res = await axios.get('http://localhost:7469/MaintenanceManage/engineer/selectAll');
                    this.engineers = res.data.map(e => ({
                        id: e.id,
                        name: e.engineerName || e.name,
                    }));

                    // 构建映射表
                    this.engineerMap = this.engineers.reduce((map, engineer) => {
                        map[engineer.id] = engineer.name;
                        return map;
                    }, {});

                } catch (error) {
                    this.$message.error('工程师列表加载失败');
                }
            },
            // 添加时间格式化方法
            formatTime(timestamp) {
                if (!timestamp) return '无时间信息';
                try {
                    const date = new Date(timestamp);
                    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}
              ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                } catch (e) {
                    return '时间格式错误';
                }
            },

            /** 初始化加载工单数据 */
            async loadOrders() {
                try {
                    this.loading = true
                    const apiMap = {
                        repair: 'repairOrder/selectAll',
                        maintain: 'maintenanceOrder/selectAll',
                        service: 'upkeepOrder/selectAll',
                        patrol: 'patrolOrder/selectAll',
                        monitor: 'checkOrder/selectAll',
                        spare: 'spareOrder/selectAll'
                    }
                    const res = await axios.get(
                        `http://localhost:7469/MaintenanceManage/${apiMap[this.activeType]}`
                    )

                    this.allOrders = (res.data.data || res.data).map(this.formatOrderData)
                } catch (error) {
                    this.$message.error('数据加载失败')
                    console.error('加载失败:', error)
                } finally {
                    this.loading = false
                }
            },

            /** 格式化工单数据 */
            formatOrderData(item) {
                const base = {
                    id: item.id,
                    orderNo: this.generateOrderNo(item.id),
                    status: parseInt(item.type),
                    // 修复时间字段映射
                    createTime:new Date().getTime(),
                    planTime: item.data,
                    // 修复设备字段映射
                    EquipmentType: item.equipmentType || item.EquipmentType || '未知类型',
                    EquipmentId: item.equipmentId || item.EquipmentId || '未知ID',
                    stop: this.stationMap[item.stop] || item.stop, // 优先显示名称
                    engineerId: item.engineerId || null,
                    engineerName: item.engineerId
                        ? this.engineerMap[item.engineerId] || '未知工程师'
                        : '待分配',
                }

                // 按类型扩展字段
                switch (this.activeType) {
                    case 'repair':
                        return {
                            ...base,
                            faultyEquipmentId: item.faultyEquipmentId,
                            faultyType: item.faultyType,
                            reportTime: item.data,
                            faultyDescription: item.faultyDescription,
                            faultyGrade: item.faultyGrade,
                            picture: item.picture,
                            faultyEquipmentType: item.faultyType
                        }
                    case 'maintain':
                        return {
                            ...base,
                            planTime: item.data
                        }
                    case 'service':
                        return {
                            ...base,
                            planTime: item.data,
                        }
                    case 'patrol':
                        return {
                            ...base,
                            planTime: item.data,
                        }
                    case 'monitor':
                        return {
                            ...base,
                            planTime: item.data,
                        }
                    case 'spare':
                        return {
                            ...base,
                            planTime: item.data,
                        }

                    default:
                        return base
                }
            },
            /** 生成工单编号 */
            generateOrderNo(id) {
                const prefix = {
                    repair: 'BX',
                    maintain: 'WX',
                    service: 'BY',
                    patrol: 'XJ',
                    monitor: 'JC',
                    spare: 'BJ'
                }[this.activeType]
                return `${prefix}${id.toString().padStart(6, '0')}`
            },
            /** 获取工程师姓名 */
            async getEngineerName(id) {
                if (!id) return '未分配';

                try {
                    // 1. 调用后端接口获取单个工程师数据
                    const res = await axios.get(`http://localhost:7469/MaintenanceManage/engineer/selectById`,
                        {
                            params: {id: id}
                        }
                    );
                    // 2. 直接返回姓名
                    return res.data.name || '未知工程师';
                } catch (error) {
                    console.error('获取工程师姓名失败:', error);
                    // 3. 处理404等错误状态
                    if (error.response?.status === 404) {
                        return '未知工程师';
                    }
                    return '获取姓名失败';
                }
            },
            // 显示配置对话框
            async showAutoAssignConfig(type) {
                this.currentAssignType = type;
                const config = this.autoConfigs[type] || {};
                this.autoEnable = config.enable || false;
                this.selectedCycle = config.cycle || null;

                // 加载关联的模板信息
                if (config.templateId) {
                    try {
                        const apiMap = {
                            service: 'upkeepOrder/selectById',
                            patrol: 'patrolOrder/selectById',
                            monitor: 'checkOrder/selectById',
                            spare: 'spareOrder/selectById'
                        };
                        const res = await axios.get(
                            `http://localhost:7469/MaintenanceManage/${apiMap[type]}`,
                            { params: { id: config.templateId } }
                        );
                        this.currentTemplate = this.formatOrderData(res.data);
                    } catch (error) {
                        console.error('模板加载失败:', error);
                        this.currentTemplate = null;
                    }
                } else {
                    this.currentTemplate = null;
                }
                this.autoAssignVisible = true;
            },

            // 保存配置
            async saveAutoConfig() {
                if (!this.currentTemplate) {
                    this.$message.error('请先创建模板工单');
                    return;
                }

                const params = {
                    orderType: this.orderTypeMapping[this.currentAssignType],
                    day: this.autoEnable ? this.selectedCycle : 0, // 关闭时设为0
                    templateOrderId: this.autoEnable ? (this.currentTemplate?.id || null) : null, // 关闭时清空
                    lastGenerateTime: new Date().toISOString()
                };

                try {
                    const res = await axios.post('http://localhost:7469/MaintenanceManage/timeSel/update', params);
                    if (res.data.code === 200) {
                        this.$message.success('配置保存成功');
                        await this.loadAutoConfigs(); // 刷新配置
                        this.autoAssignVisible = false;
                    }
                } catch (error) {
                    this.$message.error('保存失败');
                }
            },
            // 创建工单逻辑调整
            async createOrder() {
                this.$refs.orderForm.validate(async valid => {
                    if (valid) {
                        try {
                            const apiMap = {
                                service: '/upkeepOrder/add',
                                patrol: '/patrolOrder/add',
                                monitor: '/checkOrder/add',
                                spare: '/spareOrder/add'
                            };
                            const url = `http://localhost:7469/MaintenanceManage${apiMap[this.activeType]}`;
                            const postData = {
                                stop: this.newOrder.stop,
                                equipmentId: this.newOrder.equipmentId,
                                equipmentType: this.newOrder.equipmentType,
                                isTemplate: this.newOrder.isTemplate ? 1 : 0  // 转换为数字
                            }

                            const res = await axios.post(url, postData);


                            // 修改判断逻辑
                            if (res.data.code === 200 || res.data.includes("成功")) {
                                this.$message.success('工单创建成功');
                                this.createDialogVisible = false;
                                await Promise.all([
                                    this.loadOrders(),
                                    // 当创建的是模板工单时刷新相关数据
                                    this.newOrder.isTemplate && this.refreshTemplateData()
                                ]);
                                this.resetForm1();  // 新增表单重置
                            } else {
                                this.$message.error(res.data.msg || '创建失败');
                            }
                        } catch (error) {
                            this.$message.error('创建工单错误: ' + error.message);
                        }
                    }
                });
            },
            // 新增模板数据刷新方法
            async refreshTemplateData() {
                try {
                    // 双重刷新保障
                    await Promise.all([
                        this.loadAutoConfigs(),  // 刷新配置信息
                        this.loadLatestTemplate() // 直接获取最新模板
                    ]);

                    // 智能提示
                    if (this.currentTemplate) {
                        this.$message.success('模板数据已更新');
                    }
                } catch (error) {
                    console.error('模板刷新失败:', error);
                    this.$message.warning('模板状态更新失败，请手动刷新');
                }
            },
            resetForm1() {
                this.newOrder = {
                    stop: '',
                    equipmentId: '',
                    isTemplate: false
                };
                this.selectedEquipment = null;
                this.equipmentInfo = {name: '', type: ''};
                if (this.$refs.orderForm) {
                    this.$refs.orderForm.resetFields();
                }
            },
            // 加载当前模板
            async loadCurrentTemplate() {
                try {
                    const res = await axios.get('/template/getLatest', {
                        params: {orderType: this.currentAssignType}
                    });
                    this.currentTemplate = res.data;
                } catch (error) {
                    this.currentTemplate = null;
                }
            },
            // 查看模板详情
            viewTemplateDetail() {
                if (this.currentTemplate) {
                    this.currentDetail = this.currentTemplate;
                    this.detailDialogVisible = true;
                }
            },
            /** 显示派单对话框 */
            async showAssignDialog(order) {
                try {
                    const res = await axios.get('http://localhost:7469/MaintenanceManage/engineer/selectAll')
                    this.engineers = res.data.map(e => ({
                        id: e.id,
                        name: e.engineerName || e.name, // 兼容两种字段命名
                    }))
                    this.currentOrder = order
                    this.assignDialogVisible = true
                } catch (error) {
                    this.$message.error('加载工程师列表失败')
                }
            },
            /** 执行派单操作 */
            async assignOrder() {
                try {
                    const apiMap = {
                        maintain: 'maintenanceOrder/assign',
                        service: 'upkeepOrder/assign',
                        patrol: 'patrolOrder/assign',
                        monitor: 'checkOrder/assign',
                        spare: 'spareOrder/assign'
                    };

                    // 获取要处理的工单列表
                    const orders = this.isBatchAssign ? this.batchOrders : [this.currentOrder];

                    let successCount = 0;
                    const errorMessages = [];

                    for (const order of orders) {
                        try {
                            const response = await axios.post(
                                `http://localhost:7469/MaintenanceManage/${apiMap[this.activeType]}`,
                                {
                                    orderId: order.id,
                                    engineerId: this.selectedEngineer
                                }
                            );

                            if (response.data.trim() === '派单成功') {
                                successCount++;
                            } else {
                                errorMessages.push(`工单 ${order.orderNo} 失败: ${response.data}`);
                            }
                        } catch (error) {
                            errorMessages.push(`工单 ${order.orderNo} 错误: ${error.message}`);
                        }
                    }

                    // 处理结果显示
                    if (successCount > 0) {
                        this.$message.success(`成功派发 ${successCount} 个工单`);
                        await this.loadOrders();
                    }
                    if (errorMessages.length > 0) {
                        this.$message.error(errorMessages.join('\n'));
                    }

                    // 重置状态
                    this.assignDialogVisible = false;
                    this.selectedEngineer = null;
                    this.isBatchAssign = false;
                    this.batchOrders = [];
                    this.selectedOrders = [];

                } catch (error) {
                    this.$message.error(`派单请求失败: ${error.message}`);
                }
            },
            /** 查看工单详情 */
            async handleDetail(order) {
                try {
                    const apiMap = {
                        repair: 'repairOrder/selectById',
                        maintain: 'maintenanceOrder/selectById',
                        service: 'upkeepOrder/selectById',
                        patrol: 'patrolOrder/selectById',
                        monitor: 'checkOrder/selectById',
                        spare: 'spareOrder/selectById'

                    }
                    const res = await axios.get(
                        `http://localhost:7469/MaintenanceManage/${apiMap[this.activeType]}`,
                        {params: {id: order.id}}
                    )
                    this.currentDetail = this.formatOrderData(res.data)
                    this.detailDialogVisible = true
                } catch (error) {
                    this.$message.error('获取详情失败')
                }
            },

            /** 显示创建对话框 */
            async showCreateDialog() {
                await Promise.all([this.loadStations(), this.loadEquipments()])
                this.createDialogVisible = true
                this.resetForm()
            },

            /** 加载车站列表 */
            async loadStations() {
                try {
                    const res = await axios.get('http://localhost:7469/MaintenanceManage/stop/selectAll')
                    this.stationList = res.data.map(item => ({
                        id: item.id,
                        name: item.name
                    }))
                    // 生成映射关系
                    this.stationMap = res.data.reduce((map, station) => {
                        map[station.id] = station.name
                        return map
                    }, {})

                } catch (error) {
                    this.$message.error('车站列表加载失败')
                }
            },

            /** 加载设备列表 */
            async loadEquipments() {
                try {
                    const res = await axios.get('http://localhost:7469/MaintenanceManage/equipment/selectAll')
                    this.equipmentList = res.data.map(item => ({
                        id: item.id,
                        name: item.name,
                        type: item.type
                    }))
                } catch (error) {
                    this.$message.error('设备列表加载失败')
                }
            },

            /** 设备选择变化处理 */
            handleEquipmentChange(equipment) {
                this.equipmentInfo = {
                    name: equipment.name,
                    type: equipment.type
                }
                this.newOrder.equipmentId = equipment.id
                this.newOrder.equipmentType = equipment.type
            },

            /** 重置表单 */
            resetForm() {
                this.selectedEquipment = null
                this.equipmentInfo = {name: '', type: ''}
                this.newOrder = {stop: '', equipmentId: ''}
                this.$nextTick(() => {
                    if (this.$refs.orderForm) this.$refs.orderForm.clearValidate()
                })
            },

            /** 分页变化处理 */
            handlePageChange(page) {
                this.currentPage = page
            },

            /** 菜单选择处理 */
            handleMenuSelect(index) {
                if (index === '4') {
                    this.$confirm('确定退出系统吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        window.location.href = "http://localhost:7469/MaintenanceManage/logIn.html"
                    })
                    return
                }
                this.activeIndex = index
            }
        },
        created() {
            this.loadEngineers();
            this.loadOrders();
            //配置项加载
            this.loadAutoConfigs();
        },
    })
</script>
</body>
</html>